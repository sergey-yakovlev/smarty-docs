.. _portal_setup:

***************************************************
6. Установка и настройка портала для STB и Smart TV
***************************************************

Портал - это набор Javascript-приложений (JS/HTML/CSS) в разных стилевых и функциональных вариантах (шаблонов), представляющих
собой оболочку (интерфейс) для абонента. Портал загружается встроенным в устройство (приставку или Smart TV) браузером.

6.1. Установка портала
======================

Поскольку портал это статические файлы, не требующие сервера приложений с поддержкой выполнения каких-либо скриптов, то
для его хостинга достаточно любого веб-сервера. Также, при необходимости, портал может быть размещен на CDN-сервисе
или встроен в прошивку устройства.

С сервером Smarty портал взаимодействует через HTTP API посредством выполнения XMLHttpRequest-запросов.

Для хостинга портала рекомендуется использовать веб-сервер nginx.

Настройки портала задаются в файле ``client.js``, размещенном в корневой директории. Для удобства деплоя и администрирования
client.js, обычно, является симлинком на специфичный для данного провайдера конфиг, размещенный в ``/etc/microimpuls/portal/``.

.. note::

    Из-за политики ограничения выполнения кроссдоменных запросов на некоторых устройствах рекомендуется для выполнения
    запросов к Smarty использовать тот же домен, где размещен портал. В стандартном конфиге nginx для портала, который
    идет в комплекте с установочным пакетом портала, указан специальный location /api, осуществляющий редирект на
    Smarty.

.. _client_js_options:

6.2. Параметры конфигурации client.js
=====================================

В конфиге client.js задаются как основные параметры (например, данные для подключения к Smarty), так и специфичные
для каждого приложения (шаблона).

.. _client_js_main_options:

Обязательные параметры
++++++++++++++++++++++

client_id ``int``
    Client ID в Smarty.

api_key ``str``
    API key в Smarty для данного Client ID.

api_url ``str``
    Адрес сервера Smarty. Может быть задан относительно домена портала, по которому он был загружен, например, */api*.

template_name ``str``
    Название шаблона, используемого по умолчанию. Список доступных шаблонов можно посмотреть в папке templates.
    Данное значение может быть переопределено в настройках приложения в Smarty, а также в настройках аккаунта.

template_size ``array``
    Список доступных разрешений шаблонов. Необходимо указывать только в том случае, если для шаблона есть отдельно
    сверстанный стиль в соответствующее указываемое разрешение. Например, шаблон ``classic`` имеет отдельную верстку
    для разрешений 1280х720 и 720х576. Для других шаблонов используется автоматический скейлинг, поэтому размеры
    указывать не нужно.

settings_filename ``str``
    Имя файла для сохранения локальных настроек на устройстве. Желательно указывать уникальное имя (например, совпадающее
    с префиксом конфига провайдера), т.к. в этом файле сохраняются в том числе логин и пароль аккаунта. Если для
    уже работающего сервиса в процессе эксплуатации (или переезда на другой сервер) поменять это имя, то при следующем
    включении устройства у абонентов произойдет логаут.
    Значение по умолчанию *example.dat*.

.. _client_js_additional_options:

Дополнительные параметры
++++++++++++++++++++++++

site_url ``str``
    Адрес сайта провайдера. Используется в служебных сообщениях портала для абонента, связанных с информированием
    о технических неполадках и вопросами получения дополнительной информации.
    Значение по умолчанию *www.example.com*.

push_stat_interval ``int``
    Периодичность выполнения запросов к серверу Smarty для сохранения данных о телесмотрении, задается в миллисекундах.
    Не стоит использовать слишком маленькое значение, однако чем меньше это значение, тем точнее будут данные о сессиях
    просмотра и рейтинга контента. Значение по умолчанию *300000* (5 минут).

content_position_set_interval ``int``
    Периодичность выполнения запросов к серверу Smarty для сохранения текущей позиции просмотра контента PVR и VOD для
    работы функции возвращения к последней сохраненной позиции просмотра. Задается в миллисекундах.
    Значение по умолчанию *30000* (30 секунд).

default_timezone ``int``
    Значение опции, задаваемой абонентом "Часовой сдвиг" по умолчанию.
    Значение в диапазоне от 0 (что соответствует поясу -12) до 24 (+12).
    Сдвиг добавляется к системному времени на устройстве, поэтому если время задано корректно и/или используется NTP,
    то опцию default_timezone необходимо установить в значение 12 (соответствует +0).
    По умолчанию *false* (означает: не задано).

default_buffersize ``int``
    Значение опции, задаваемой абонентом "Размер буферизации" по умолчанию. Варианты:
    0 - автоматически;
    1 - нет буферизации;
    2 - малый буфер;
    3 - средний буфер;
    4 - большой буфер;
    5 - очень большой буфер.
    По умолчанию *false* (означает: не задано).

default_lang ``int``
    Значение опции, задаваемой абонентом "Язык интерфейса" по умолчанию. Означает индекс (начиная с 0) языка из списка
    языков, которые поддерживаются конкретным шаблоном.
    По умолчанию *false* (означает: не задано).

system_debug ``bool``
    Включает показ системной консоли портала, в которой отображается дополнительная служебная информация для отладки.
    По умолчанию *false*.

user_debug ``bool``
    Включает показ сообщений абоненту о различных служебных ошибках, возникших в ходе работы портала (в том числе,
    например, ошибки связи с сервером Middleware).
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``futuristic``.

available_templates ``array``
    Устанавливает список доступных шаблонов для переопределения с сервера. Шаблон, указанный в обязательном
    параметре template_name, в список доступных шаблонов добавлять не обязательно. При попытке сервера определить
    для устройства и/или аккаунта шаблон, отсутствующий в данном списке, приложение это проигнорирует.
    По умолчанию *[]*.

handle_key_power_by_device ``bool``
    Флаг для выбора обработки кнопки выключения приставки.
    При значении *false* кнопка выключения будет обрабатываться на уровне приложения.
    При значении *true* кнопка выключения будет обрабатываться на уровне приставки.
    По умолчанию *false*.

send_device_model_in_request_parameters ``bool``
    Флаг для передачи модели вместе с типом устройства на сервер.
    При значении *false* на сервер отправляется только тип устройства без модели, например android_stb.
    При значении *true* на сервеи отправляется тип устройства + нижнее подчеркивание + модель, например: android_stb_redbox.
    По умолчанию *true*.

begin_channel_numbers_from_zero ``bool``
    Флаг для установки порядка в списке каналов.
    При значении *false* порядок начинается с 1.
    При значении *true* порядок начинается с 0.
    По умолчанию *false*.

tvzavr_intro_url ``str``
    Адрес до интро-файла для онлайн-кинотеатра tvzavr.
    По умолчанию *не задано*.

default_player_solution_for_mag ``str``
    Устанавливает для плеера MAG тип медиа контента, который будет использоваться если формат потока не удалось определить.
    Значением должен быть тип формата контента (см. список http://soft.infomir.com/stbapi/JS/v343/tutorial-media-formats.html).
    По умолчанию *auto*.

requests_timeout_time ``int``
    Устанавливает для HTTP-запросов время ожидания ответа от сервера, после которого запрос будет прерван со стороны клиента.
    Задается в миллисекундах.
    По умолчанию *10000*.

android_uid_generation_method  ``str``
    Поле, позволяющее переопределить метод генерации UID для устройств под OS Android.
    Возможные значения:
    default - используется стандарный метод генерации
    mac - в качестве UID всегда возвращается MAC-адрес
    serial - в качестве UID всегда возвращается серийный номер
    mac_serial - в качестве UID всегда возвращается комбинация mac-адреса и серийного номера, разделенных нижним подчеркиванием
    По умолчанию *default*.

.. _client_js_specific_options:

Специфичные для шаблонов параметры
++++++++++++++++++++++++++++++++++

signup_auto_activation_period ``int``
    Количество дней, на которое будет выдан бесплатный доступ для первичного использования аккаунта после регистрации.
    По умолчанию *0*.
    Поддерживается только в шаблонах: ``impuls``.

show_welcome_message ``bool``
    Показывать или нет приветственное сообщение при первом запуске приложения.
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``impuls``.

welcome_message ``str``
    Текст приветственного сообщения при первом запуске приложеня.
    По умолчанию *не задан*.
    Поддерживается только в шаблонах: ``impuls``.

registration_available ``bool``
    Показывать или нет кнопку и экран регистрации через СМС.
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``impuls``, ``futuristic``.

settings_menu_custom_items ``list``
    Список ключей дополнительных пунктов меню настроек в интерфейсе абонента. Пример настройки ниже.
    По умолчанию *[]*.
    Поддерживается только в шаблонах: ``impuls``.

auth_mode ``str``
    Режим авторизации устройства. Возможные значения:
    *abonement* - только по логину, без пароля (реализовано только для шаблона ``focus``);
    *password* - по логину и паролю (по умолчанию);
    *device_uid* - по уникальному идентификатору устройства (обычно MAC-адресу) или по IP-адресу.
    В случае неуспешной авторизации абоненту будет предложена авторизация по логину и паролю.
    *device_uid_wo_fallback* - то же самое, что *device_uid*, но без обработки некоторых ситуаций
    неуспешной авторизации и перехода на авторизацию по логину и паролю.
    Поддерживается только в шаблонах: ``impuls``, ``focus``, ``futuristic``.


play_record_continuously ``bool``
    Режим воспроизведения передач в архиве, при значении *true* архив воспроизводится непрерывно с автоматическим
    переходом на следующую передачу, при значении *false* по окончанию передачи происходит переключение в прямой эфир.
    По умолчанию *true*.
    Поддерживается только в шаблонах: ``focus`` (в остальных шаблонах  всегда режим непрерывного воспроизведения).

server_rewind_mode ``bool``
    Режим перемотки плеера. При значении *true* при перемотке будет использоваться позиционирование с помощью указания
    временной метки видео-серверу с перезапросом видеопотока. При значении *false* - перемотка по потоку методом seek
    средствами плеера (работает не всегда корректно из-за различной реализации на плеерах, однако быстрее).
    По умолчанию *true*.
    Поддерживается только в шаблонах: ``impuls``, ``focus``, ``futuristic``.

use_template_default_resolution ``bool``
    При значении *true* если на приставке MAG выбрано разрешение больше чем 1280х720, то оно будет изменено на 1280х720
    с выдачей сообщения о смене разрешения.
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``focus``.

show_disconnect_message ``bool``
    Показывать или нет сообщение об ошибке при разрыве соединения приставки с сетью.
    По умолчанию *true*.
    Поддерживается только в шаблонах: ``focus``.

samsung_guidelines_compatibility_mode ``bool``
    Включить или нет режим соблюдения гайдлайнов Samsung (используется для включения некоторых специальных ограничений
    для более простой публикации в магазин Samsung).
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``impuls``, ``futuristic``.

auto_launch_last_viewed_channel ``bool``
    Значение по умолчанию для опции, задаваемой абонентом - "Воспроизводить последний просматриваемый канал"
    автоматически при запуске приложения.
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``impuls``, ``futuristic``.

is_letters_in_password ``bool``
    Разрешено ли использовать буквы в пароле в экранной клавиатуре при авторизации.
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``impuls``, ``futuristic``.

vod_show_news ``bool``
    Показывать ли категорию видеотеки "Новинки".
    По умолчанию *true*.
    Поддерживается только в шаблонах: ``impuls``, ``futuristic``.

vod_show_packages ``bool``
    Показывать ли категорию видеотеки "Пакеты фильмов".
    По умолчанию *true*.
    Поддерживается только в шаблонах: ``futuristic``.

vod_show_purchased ``bool``
    Показывать ли категорию видеотеки "Купленное".
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``futuristic``.

vod_show_viewed ``bool``
    Показывать ли категорию видеотеки "Просмотренное".
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``futuristic``.

show_logout_option ``bool``
    Показывать ли кнопку и возможность логаута в экране профиля.
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``futuristic``.

show_main_menu_on_first_launch ``bool``
    Показывать ли главное меню после загрузки портала. Если *false*, то будет открыт экран плеера.
    По умолчанию *true*.
    Поддерживается только в шаблонах: ``futuristic``.

navigation_mode ``str``
    Режим навигации в приложении, возможные значения:
    *normal* - обычная навигация;
    *horizontal* - переход между экранами стрелками пульта.
    По умолчанию *normal*.
    Поддерживается только в шаблонах: ``impuls``, ``futuristic``.

disable_set_button_on_mag ``bool``
    При значении *true* кнопка **Setup** на пульте приставки MAG будет заблокирована.
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``futuristic``.

restore_login_form_inputs_from_settings ``bool``
    Отображать ли значения полей "Логин" и "Пароль" в форме авторизации при перезапуске приложения.
    При методе авторизации *password* рекомендуется использовать эту опцию.
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``futuristic``.

tv_channels_list_mode ``str``
    Режим отображения списка каналов. Возможные значения для шаблона ``futuristic``:
    *list* - список по умолчанию;
    *grid* - сетка;
    *longlist* - длинный список (10 каналов на страницу вместо 5).
    Возможные значения для шаблона ``impuls``:
    *list* - список по умолчанию;
    *preview* - с окном предпросмотра (плеером).
    По умолчанию *list*.
    Поддерживается только в шаблонах: ``futuristic``, ``impuls``.

allow_to_change_tv_channels_list_mode ``bool``
    Разрешить ли абоненту изменять режим отображения каналов.
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``futuristic``.

custom_body_class ``str``
    Подключить дополнительный класс к тегу body портала.
    По умолчанию *не задан*.
    Поддерживается только в шаблонах: ``futuristic``.

change_volume_on_left_right_arrows_keys ``bool``
    Включить управление громкостью с помощью стрелок пульта дополнительно к обычным кнопкам громкости.
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``impuls``.

open_infobar_on_ok_key ``bool``
    При значении *true* инфобар будет открываться по нажатию кнопки OK (если он был скрыт).
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``impuls``.

loop_epg_screen_menu_on_up_down_keys ``bool``
    При значении *true* в экране EPG при достижении начала списка и переходе вверх будет происходить переход в конец
    текущего дня, а при переходе вниз с конца - в начало списка (режим зацикливания), без перехода по дням.
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``impuls``.

reboot_device_after_login_with_password ``bool``
    При значении *true* после авторизации абонента логином и паролем через форму авторизации произойдет перезагрузка
    устройства. Может быть использовано для выполнения системных операций биллинга при первичной "активации" приставки
    абонентом.
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``futuristic``.

show_number_of_channels_in_all_category ``bool``
    При значении *true* в разделе "ТВ" в названии категории "Все каналы" будет добавлено отображения количества
    телеканалов в этой категории.
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``futuristic``.

default_notification_time ``int``
    Время, за которое должно показываться напоминание о передаче (напоминания устанавливаются на грядущие передачи из
    экрана "Программа".
    Доступные значения: *0* - 5 минут, *1* - 15 минут, *2* - 30 минут, *3* - 1 час, *4* - 2 часа.
    По умолчанию *0*.
    Поддерживается только в шаблонах: ``impuls``.

account_renewal_message ``str``
    Текст сообщения, которое выводится пользователю при окончании его подписки. В нём, как правило, указывается способ
    продления подписки.
    По умолчанию *не задан*, показывается сообщение, зашитое в приложение.
    Поддерживается только в шаблонах: ``impuls``.

player_rewind_step ``int``
    Шаг перемотки плеера в секундах, в режиме архива и VOD. По умолчанию 30 секунд.
    Поддерживается только в шаблонах: ``impuls``, ``futuristic``.

allow_to_change_data_center ``bool``
    При значении *true* в настройках абонента появится возможность изменения дата-центра (сервера вещания).
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``futuristic``.

show_balance_menu ``bool``
    При значении *true* будет отображаться меню "Баланс".
    По умолчанию *true*.
    Поддерживается только в шаблонах: ``futuristic``.

show_messages_menu ``bool``
    При значении *true* будет отображаться меню "Сообщения".
    По умолчанию *true*.
    Поддерживается только в шаблонах: ``futuristic``.

allow_autoregistration ``bool``
    При значении *true* при первом запуске приложения на устройстве происходит регистрация нового аккаунта.
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``impuls``.

switching_channels_inside_category ``bool``
    При значении *true* переключение каналов кнопками CH+/CH- будет происходить внутри выбранной категории каналов,
    а не в полном списке каналов.
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``futuristic``.

main_screen_mode ``str``
    Режим отображения главного меню портала. Возможные значения для шаблона ``futuristic``:
    *classic_menu* - стандартное меню с виджетами;
    *showcase* - витрина с контентом, виджетами, приложениями и меню.
    По умолчанию ``classic_menu``.
    Поддерживается только в шаблонах: ``futuristic``.

allow_to_change_main_screen_mode ``bool``
    При значении *true* при нажатии желтой кнопки в главное меню будет изменяться режим *main_screen_mode*.
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``futuristic``.

tv_show_favorites ``bool``
    При значении *true* в шаблоне для экрана "ТВ" будет включена категория "Избранное".
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``futuristic``.

check_account_template ``bool``
    При значении *true* после авторизации акканта будет осуществляться проверка шаблона, установленного в настройках аккаунта в Smarty,
    и если он отличается от используемого приложение будет перезагружено в нужном шаблоне.
    По умолчанию *true*.
    Поддерживается только в шаблонах: ``futuristic``.

save_aspect_ratio_per_channel ``bool``
    При значении *true* в настройках портала на устройстве выбранное соотношение сторон будет сохраняться отдельно
    для каждого канала, при значении *false* - общее значение для всех каналов.
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``futuristic``.

save_audio_track_lang_per_channel ``bool``
    При значении *true* в настройках портала на устройстве выбранный язык аудио-дорожки будет сохраняться отдельно
    для каждого канала, при значении *false* - выбранный по умолчанию язык аудио будет одинаковым для всех каналов.
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``futuristic``.

set_default_aspect_ratio_for_vod ``bool``
    При значении *true* в настройках портала на устройстве для VOD по умолчанию устанавливается разрешение 16х9.
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``impuls``.

show_sort_screen ``bool``
    При значении *true* в настройках портала в экране настроек отображается экран сортировки каналов.
    При значении *false* такого пункта в настройках нет.
    По умолчанию *true*.
    Поддерживается только в шаблонах: ``impuls``.

show_vod_premiere_in_news ``bool``
    При значении *true* в категории "Новинки" раздела "Кинотеатр" отображаются премьеры фильмов
    (в метод tvmiddleware/api/video/list передается параметр premiere=1).
    При значении *false* в категории "Новинки" раздела "Кинотеатр" отображаются последние добавленные в сервис фильмы
    (в метод tvmiddleware/api/video/list передается параметр new=1)
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``impuls``.

default_vod_sort_order ``str``
    Тип сортировки фильмов по умолчанию. Возможные значения для шаблона ``impuls``:
    *-created_at* - по дате добавления в сервис (сначала самые новые);
    *-kinopoisk_rating* - по рейтингу Кинопоиска (сначала самые популярные);
    *-imdb_rating* - по рейтингу IMDB (сначала самые популярные);
    *-year* - по году выхода фильма (сначала самые новые);
    *-premiere_date* - по дате выхода премьеры фильма (сначала самые новые);
    *name* - по названию (в алфавитном порядке).
    По умолчанию ``-created_at``.
    Поддерживается только в шаблонах: ``impuls``.

filter_videos_by_genres ``bool``
    При значении *true* в экране кинотеатра фильмы группируются по жанрам.
    При значении *false* в экране кинотеатра фильмы группируются по жанрам-категориям.
    По умолчанию *true*.
    Поддерживается только в шаблонах: ``impuls``.

merchant_type ``str``
    Тип мерчанта для оплаты внутри шаблона. Если данный параметр не определен, то используется мерчант, установленный
    по умолчанию на сервере.
    По умолчанию *не задан*.
    Поддерживается только в шаблонах: ``impuls``.

template_of_payment_page ``str``
    Шаблон внешней страницы оплаты, который необходимо открыть. Возможные значения для платежного шлюза Payture:
    *не задан* - вернется шаблон, кастомизированный под открытие на телевизорах и STB с браузерами, поддерживающими TLS1.2
    (кроме Samsung Smart TV под Orsay).
    *Orsay* - вернется шаблон, кастомизированный под открытие на Samsung Smart TV под Orsay.
    *Payture* - вернется стандартная форма Payture, адаптивная под десктопные и мобильные браузеры.
    По умолчанию *не задан*.
    Поддерживается только в шаблонах: ``impuls``.

samsung_smart_tv_volume_control_off ``bool``
    Флаг для отключения управления звуком на уровне приложения для устройств Samsung Smart TV под Orsay.
    При значении *false* управление звуком осуществляется на уровне приложения.
    При значении *true* управление звуком осуществляется на уровне системы (стандартное управление внутри телевизора).
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``futuristic``.

vod_mode ``str``
    Настройка для выбора режима видеотеки. Возможные значения:
    *classic* - отображение видеотеки по умолчанию (списком).
    *showcase* - отображение видеотеки в режиме "Витрина".
    По умолчанию *classic*.
    Поддерживается только в шаблонах: ``futuristic``.

save_last_tvcategory ``bool``
    Флаг для установки последней просматриваемой категории при запуске приложения.
    При значении *false* будет открываться категория "Все".
    При значении *true* будет открываться та категория, которая была открыта перед закрытием приложения.
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``futuristic``.

epg_list_mode ``str``
    Режим отображения списка программы передач.
    При значении *list* отображается список по умолчанию.
    При значении *longlist* отображается длинный список без дополнительной информации о каждой передаче.
    По умолчанию *list*.
    Поддерживается только в шаблонах: ``futuristic``.

show_media_portal_service_on_mag ``bool``
    Флаг для отображения медиа-портала на приставках mag.
    По умолчанию *true*.
    Поддерживается только в шаблонах: ``futuristic``.

open_sort_from_tv ``bool``
    Флаг для включения быстрого перехода к экрану «Сортировка каналов» из экрана «ТВ».
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``futuristic``.

vod_list_mode ``str``
    Режим отображения списка фильмов в видеотеке.
    При значении *grid* отображается стандартная сетка фильмов в постерами.
    При значении *longlist* отображается длинный список фильмов без постеров.
    По умолчанию *grid*.
    Поддерживается только в шаблонах: ``futuristic``.

switch_channels_in_preview_mode ``bool``
    Флаг, который при каждом переключении канала в экране "Телеканалы" в режиме preview запускает выделенный канал в
    масштабированном окне плеера.
    При значении *false* во время переключения канала меняется только описание под плеером.
    При значении *true* во время переключения канала обновляется и проигрываемый канал.
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``impuls``.

use_remote_button_back_as_backspace_in_virtual_keyboard ``bool``
    Флаг, который меняет поведение кнопки Back во время отображения экранной клавиатуры.
    При значении *false* кнопка Back закрывает экранную клавиатуру.
    При значении *true* кнопка Back работает как Backspace.
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``futuristic``.

enable_instant_search_for_vod ``bool``
    Флаг, включающий режим поиска фильмов по мере ввода символов.
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``futuristic``.

stop_player_on_screen_showing ``bool``
    Флаг, включающий режим остановки плеера при переходе на другой экран.
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``futuristic``.

show_help_button_panel ``bool``
    Флаг для отображения вспомогательной панели с кнопками (необходима для пультов с урезанным набором кнопок).
    По умолчанию *true*.
    Поддерживается только в шаблонах: ``impuls``, ``futuristic``.

block_requests_in_standby ``bool``
    Включает блокировку запросов к серверу, если устройство находится в режиме Stand-By.
    После выхода из Stand-By отправка запросов к серверу восстанавливается, однако данные в интерфейсе могут быть
    устаревшими в течение некоторого времени.
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``futuristic``, ``infinitly``.

infobar_time_display_mode ``str``
    Меняет отображение времени начала и конца передачи в инфобаре в режиме архива или остановленного Live TV.
    При значении *by_epg* время в инфобаре отображается согласно программе передач.
    При значении *by_duration* время начала передачи устанавливается 00:00, а время конца - длительность передачи.
    По умолчанию *by_epg*.
    Поддерживается только в шаблонах: ``impuls``.

autoregistration_message ``str``
    Сообщение, которое отображается после успешной авторегистрации.
    По умолчанию *не задано*.
    Поддерживается только в шаблонах: ``impuls``.

is_letters_in_login ``bool``
    Флаг, позволяющий вводить в поле пароля на экране авторизации буквы.
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``impuls``.

vod_show_favorited ``bool``
    Флаг, отвечающий за отображение категории "Избранное" в экране VOD.
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``focus``, ``futuristic``.

vod_show_all ``bool``
    Флаг, отвечающий за отображение категории "Все" в экране VOD.
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``futuristic``.

allow_to_change_access_restriction_for_purchase_content ``bool``
    Флаг, который добавляет в список настроек пункт для изменения доступа к покупкам.
    По умолчанию *true*.
    Поддерживается только в шаблонах: ``futuristic``.

show_payment_menu ``bool``
    Флаг, который добавляет в список экрана "Мой профиль" пункт оплаты.
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``futuristic``.

epg_hide_zero_plus_rating ``bool``
    Флаг, который скрывает для передач с рейтингом 0+ их рейтинг.
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``futuristic``.

default_purchase_content_access_mode ``str``
    Значение по умолчанию для пункта настроек для изменения доступа покупкам.
    При значении *pin* по умолчанию выставляется пункт "Оплата контента с пин-кодом".
    При значении *allow* по умолчанию выставляется пункт "Оплата контента без пин-кода".
    По умолчанию *allow*.
    Поддерживается только в шаблонах: ``futuristic``.

show_tv_menu_and_play_first_channel_on_first_launch ``bool``
    Флаг, который при первом запуске приложения открывает список телеканалов и запускает первый по списку канал.
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``futuristic``.

monitoring_interval_sys_info ``int``
    Периодичность (в миллисекундах), с которой портал будет отправлять системные метрики с устройства на сервер Smarty MVision.
    Отправка метрик должна быть также включена в настройках устройства в панели администратора Smarty.
    По умолчанию *300000*.
    Поддерживается только в шаблонах: ``impuls``, ``futuristic``.

monitoring_interval_metrics ``int``
    Периодичность (в миллисекундах), с которой портал будет отправлять метрики производительности и качества видео с устройства на сервер Smarty MVision.
    Отправка метрик должна быть также включена в настройках устройства в панели администратора Smarty.
    По умолчанию *15000*.
    Поддерживается только в шаблонах: ``impuls``, ``futuristic``.

show_offer_accept ``bool``
    Флаг, отвечающий за показ попапа с подтверждением согласия с офертой перед оплатой. Офертой автоматически считается
    нулевой по порядку правовой документ в Smarty. Если документов нет или нулевой по порядку документ не требует акцепта,
    то попап не будет показан.
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``impuls``.

autohide_timer ``number``
    Тайм-аут (в минутах), по истечению которого должен быть скрыт текущий экран и открыт экран плеера, если в настоящий
    момент есть воспроизведение какого-то контента.
    По умолчанию *0*.
    Поддерживается только в шаблонах: ``futuristic``, ``infinitly``.

registration_phone_mask ``str``
    Маска номера мобильного телефона, используемая в поле регистрации абонента.
    По умолчанию *+7 ??? ??? ?? ??*.
    Поддерживается только специальный символ *?*, вместо которого будет подставляться вводимое значение, остальные
    символы будут отображены как есть.
    Поддерживается только в шаблонах: ``futuristic``.

loading_timeout ``int``
    Количество миллисекунд, на которое будет задержана первоначальная загрузка портала. Может быть использовано, например,
    для кастомизации портала, чтобы перед запуском отобразить приветственную картинку.
    По умолчанию 1.
    Поддерживается только в шаблонах: ``futuristic``.

max_epg_depth ``int``
    Определяет глубину EPG в днях для экрана "Телепрограмма".
    Если опция больше 0, то глубина будет равна значению опции. Если опция не задана (равна 0): для канала с архивом будет использована глубина архива (поле max_archive_duration канала), если у канала нет архива - программа передач будет отображаться только за текущий день.
    По умолчанию 0.
    Поддерживается только в шаблонах: ``futuristic``.

service_description ``str``
    Поле, позволяющее задать описание сервиса. В разных шаблонах отображается в разных экранах.
    В шаблоне ``impuls`` отображается на экране "О сервисе", который добаляется в список пунктов экрана "Мой профиль" при
    наличии этого поля.
    По умолчанию *не задано*.
    Поддерживается только в шаблонах: ``impuls``.
    
template_styles ``array``
    Список доступных для абонента стилей оформления шаблона. Изменить стиль можно в экране настроек. Стиль оформления никак не влияет на функционал шаблона.
    По умолчанию *[]*
    Поддерживается только в шаблонах: ``futuristic``.

template_style ``str``
    Имя стиля оформления шаблона, используемое по дефолту.
    По умолчанию *не задано*.
    Поддерживается только в шаблонах: ``futuristic``.
    Доступные значения для шаблона ``futuristic``:
    *futuristic_x* - минималистичный стиль оформления.

.. _portal_event_system:

6.3. Механизм событий
=====================

События позволяют добавлять или переопределять некоторый функционал портала в разные моменты его жизненного цикла.
Обработчики событий задаются в конфиге client.js, что позволяет сохранить кастомные настройки и функции даже при обновлении
портала на новую версию.

Доступные события:

* *OnDataRequestError* - ошибка выполнения запроса к Smarty, в качестве аргумента - код ошибки
* *OnAppInitBegin* - старт инициализации приложения
* *OnAppInitEnd* - завершение инициализации приложения
* *OnDeviceInitBegin* - старт инициализации драйвера устройства
* *OnDeviceInitEnd* - завершение инициализации драйвера устройства
* *OnDeviceKeyEvent* - событие нажатия клавиши пульта, в качестве аргумента - код клавиши
* *OnAccountLoginSuccessful* - успешная авторизация аккаунта

Жизненный цикл: *OnAppInitBegin > OnDeviceInitBegin > OnDeviceInitEnd > OnAppInitEnd*.

Пример создания обработчиков событий приведен ниже.

.. note::

    Внимание! Использование этого механизма требует навыков программирования на Javascript, знания архитектуры и API портала и API устройств.

6.4. Пример конфигурации
========================

Пример ниже предназначен для шаблона ``impuls`` и кроме стандартного поведения добавляет дополнительный пункт в меню
настроек абонента - "Режим ожидания", включающий или отключающий обработку событий подключения/отключения HDMI-кабеля
на приставке MAG, а также проверяет версию прошивки и запускает обновление в случае необходимости при старте
приложения и добавляет некоторые другие функции. ::

    var CLIENT_SETTINGS = {
        'client_id': 1,
        'api_key': '***',
        'api_url': '/api',
        'template_name': 'impuls',
        'template_size': {
            'impuls': {
                'default': [1280, 720]
            },
            'classic': {
                'default': [1280, 720],
                '720x576': [720, 576]
            },
        },
        'settings_filename': 'example.dat',
        'site_url': 'www.example.com',
        'signup_auto_activation_period': 0,
        'show_welcome_message': false,1
        'registration_available': false,
        'settings_menu_custom_items': [
            'handle-hdmi-events'
        ],
        'auth_mode': 'device_uid',
        'default_timezone': 12,
        'default_buffersize': 3,
    };

    OnAppInitBegin = function()
    {
        // Автоматическое выключение плеера ночью в 01:30 по локальному времени
        setInterval(function(){
            var date = new Date();
            if (date.getHours() == 1 && date.getMinutes() == 30) {
                App.player.stop();
                App.display.showScreen('tvchannels');
            }
        }, 35000);

        // Обновление прошивки для определенных старых версий
        try {
            var fver = parseInt(gSTB.RDir('ImageVersion'));
            var desc = gSTB.GetDeviceImageDesc();
            if (desc == 'default-214') {
                stbUpdate.startAutoUpdate("http://update.example.com/imageupdate", true);
            }
        } catch (e) {}
    };

    OnAppInitEnd = function()
    {
        // Подключение custom css верстки
        var el = document.createElement('link');
        el.rel = 'stylesheet';
        el.type = 'text/css';
        el.href = '/custom/css/custom.css';
        document.getElementsByTagName('body')[0].appendChild(el);

        // Подключение режима overscan для шаблона impuls
        Helper.addBodyClass('overscan');

        // Переопределение кнопки EPG на красную кнопку
        App.playerScreen.key_epg = App.playerScreen.key_red;
        App.tvChannelsScreen.key_epg = App.tvChannelsScreen.key_red;

        // Переопределение обработчика кнопки Power
        App.display.setGlobalKeyCodeHandler('power', function(){
            App.player.stop();
            App.display.showScreen('mainmenu');
        }, App.playerScreen);
    };

    OnDeviceInitBegin = function()
    {
        // Добавление меню настройки режима ожидания
        var handleHdmiEventsMenu = new BaseMenu({
            menuTag: 'ul',
            itemIdPrefix: 'settings-handle-hdmi-events-value',
            useItemIdWithoutIndex: true,
            itemTag: 'span',
            displayItemsNumber: 1,
            sourceItemsNumber: 2,
            useFastRefresh: false,
            getItemNameFunc: function(sourceItemIndex, displayItemIndex) {
                var names = [
                    'Отключен',
                    'Включен'
                ];
                return names[sourceItemIndex];
            }
        });
        App.settings.setCustomSetting('handle-hdmi-events', 1);
        App.lang.set('ru', 'label-settings-handle-hdmi-events', 'Режим ожидания');
        App.settingsScreen.addCustomSettingsMenu('handle-hdmi-events', handleHdmiEventsMenu);
    };

    OnDeviceInitEnd = function()
    {
        // Установка произвольной прозрачности интерфейса
        App.device.setWindowTransparencyLevel(230);

        // Установка режима 16:9 по умолчанию
        App.device.setAspectRatioMode('16:9');

        // Обработка событий HDMI для MAG
        if (App.device.getDeviceKind() === 'mag') {
            App.device.standBy = false;
            App.device.standByTimer = null;
            App.device.onEvent = function(code) {
                switch (code) {
                    default:
                        break;
                    case 0x20: // HDMI connected
                        if (Helper.toInt(App.settings.getCustomSetting('handle-hdmi-events')) == 1) {
                            clearTimeout(App.device.standByTimer);
                            if (App.device.standBy) {
                                App.device.stb.StandBy(false);
                                App.device.standBy = false;
                            }
                        }
                        break;
                    case 0x21: // HDMI disconnected
                        if (Helper.toInt(App.settings.getCustomSetting('handle-hdmi-events')) == 1) {
                            clearTimeout(App.device.standByTimer);
                            App.device.standByTimer = setTimeout(function () {
                                if (!App.device.standBy) {
                                    if (App.player.isActive()) {
                                        App.player.stop();
                                        App.display.showScreen('tvchannels');
                                    }
                                    App.device.stb.StandBy(true);
                                    App.device.standBy = true;
                                }
                            }, 60 * 5 * 1000);
                        }
                        break;
                }
            }
        }
    };

    OnAccountLoginSuccessful = function()
    {
        // Изменение формата отображения оставшихся дней активации на dd/mm/yyyy
        var value = App.data.getActivationDaysLeft();
        if (parseInt(value) <= 0) {
            value = App.lang.get('auto-renewal');
        } else {
            var d = new Date(new Date().getTime()+(parseInt(value)*24*60*60*1000));
            var dd = d.getDate();
            var mm = d.getMonth() + 1;
            var y = d.getFullYear();
            value = dd + '/' + mm + '/' + y;
        }
        Helper.setHtml('info-menu-activation-days-left', value);
    };

6.5 Кастомизация стилей оформления портала
==========================================

Smarty позволяет для каждого устройства задать внешний css-файл для кастомного оформления портала, например, установить
своё фоновое изображение, сменить цвет шрифта или фокуса.

Для этого необходимо открыть в панели администрирования "Общие настройки" -> "Настройки STB и приложений" ->
<устройство для настройки> и прописать в поле "Внешний CSS" путь до файла с новыми стилями. Как правило, данный файл
располагают на том же веб-сервере, что и портал.

Для создания файла с внешними стилями достаточно с помощью отладчика любого браузера проследить какие классы и
идентификаторы отвечают за тот или иной элемент экрана в портале, после чего перезаписать/дописать нужные свойства к ним.
Ниже представлены самые часто встречающиеся примеры кастомизации для шаблонов ``futuristic`` и ``impuls``.

Пример внешнего css-файла для кастомизации шаблона ``futuristic``. ::

    /* Установка кастомного фонового изображения */

    .screen, .android_stb .screen {
        background: url('example-bg.jpg') no-repeat;
    }

    /* Установка кастомного фонового изображения для верхней панели с лого оператора */

    #statusbar-screen {
        background: transparent url('statusbar-bg.png') no-repeat;
    }

    /* Установка кастомного изображения для фокуса главного меню  */

    div#main-menu-selection {
        background: transparent url('example-selection-bg.png') no-repeat center 0px;
    }

Пример внешнего css-файла для кастомизации шаблона ``impuls``. ::

    /* Установка кастомного лоадера */

    .screen-container.loader, #player-mode-icon.loader, #loading-bar {
        background: transparent url("loader-example.gif") center center no-repeat;
    }

    #firstloading-loader {
        background: url('loader-example.gif') no-repeat;
        height: 65px;
        width: 120px;
    }

    .loader#video-actions-panel {
        background: transparent url("loader-example.gif") center left no-repeat;
        height: 120px;
    }

    /* Установка кастомного фонового изображения */

    .screen, body, .play .screen, .png-transparency .screen, .play.png-transparency .screen,
    .transparent.png-transparency .screen, .transparent .screen {
        background: url('example-bg.jpg') no-repeat;
    }

    body.play {
        background: transparent;
    }

    /* Установка кастомных координат для логотипа оператора */

    .client-logo {
        margin-top: 75px !important;
        margin-right: 30px;
    }

.. note::

    Нужно учесть, что для корректной работы внешних стилей, необходимо, чтобы все дополнительные ресурсы (изображения,
    шрифты), используемые в них, были доступны и имели правильные пути.

.. note::
    После установки обновлений шаблонов необходимо внимательно читать changelog и тщательно тестировать портал на
    предмет корректности работы внешнего CSS, так как внутренние css- и html-файлы могут претерпевать изменения, что
    так или иначе влияет на отображение кастомных стилей.


